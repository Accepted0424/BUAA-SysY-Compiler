# 词法分析模块设计

## 一、编码前的设计与规划

词法分析模块作为编译器前端的首个处理阶段，其核心职责在于将源程序的字符流转换为结构化的 Token 流，为后续语法分析提供规范化输入。本模块在编码前即进行了较为完整的功能规划与接口设计。

### 1. 设计目标

词法分析器需完整支持 SysY 语言子集所涉及的词法单元类型，具体包括：

* **关键字（Keyword）**
* **标识符（Identifier）**
* **整数常量（Integer Literal）**
* **字符串常量（String Literal）**
* **运算符（Operator）**
* **分隔符（Delimiter）**

在扫描过程中，分析器应能够：

* 自动忽略空白字符（空格、制表符、换行符等）；
* 正确跳过注释内容；
* 对非法字符进行识别与记录，而不中断整体扫描流程。

### 2. Token 数据结构设计

每一个 Token 由以下核心信息构成：

* **Token 类型**：表示词法单元的语义类别；
* **原始文本（Lexeme）**：对应源代码中的字符串片段；
* **行号信息**：用于错误定位与诊断。

该结构设计在保证信息完备性的同时，避免引入与语法或语义阶段耦合的多余字段。

### 3. 词法分析算法与流程

词法分析采用**基于字符流的顺序扫描（Streaming Scan）**策略，底层提供 `peek / get / unget` 等字符级操作接口，以支持有限回溯需求。

整体识别流程遵循明确的优先级顺序：

1. **空白字符与注释**：首先跳过，不产生 Token；
2. **关键字与标识符**：以字母或下划线开头，最长匹配；
3. **数字常量**：连续数字序列解析为整数常量；
4. **字符串常量**：处理引号包裹的字符串，并支持转义与错误检测；
5. **复合运算符**：如 `&&`、`||`、`!=`、`==`、`<=`、`>=`；
6. **单字符符号**：包括算术运算符、分隔符等。

在扫描过程中同步维护行号信息；当遇到无法归类的非法字符时，生成特定错误标记（如 `ERR_ILLEGAL_SYMBOL`），用于后续统一错误报告。

### 4. 对外接口设计

词法分析模块对外暴露统一接口：

```cpp
Lexer::next(Token &token)
```

该接口以“逐 Token 拉取”的方式工作，调用方无需关心底层扫描状态，从而实现词法分析与语法分析之间的良好解耦。

---

## 二、编码完成后的实现调整与优化

在具体实现过程中，基于工程可维护性与代码结构清晰性的考虑，对原有设计进行了若干合理调整与增强。

### 1. 关键字识别机制优化

关键字集合以**静态关键字表**的形式定义并内置于 `Lexer` 类中，通过字符串到 Token 类型的直接映射完成识别。
该设计避免了在主扫描流程中引入冗长的条件分支，提高了关键字判断的效率与可读性。

### 2. 注释处理策略统一

分析器完整支持：

* **单行注释**
* **块注释**

所有注释均在 `Lexer::next` 的内部逻辑中被统一跳过，使得对外接口始终只暴露有效 Token，简化了语法分析阶段的处理逻辑。

### 3. 复合运算符的专用处理

针对 `&&`、`||`、`!=`、`==`、`<=`、`>=` 等多字符运算符，引入专用分支处理函数，将相关逻辑从主扫描流程中抽离。
该做法有效降低了主流程的复杂度，同时提高了代码的可扩展性，便于后续引入新的复合运算符。

### 4. 行号维护机制改进

行号信息的更新逻辑被集中于底层字符读取接口 `getChar / ungetChar` 中统一维护，而非分散在各类识别分支中。
这一设计确保了：

* 行号变化语义清晰、来源唯一；
* 错误定位信息在所有情况下保持一致性；
* 避免因回退读取导致的行号错乱问题。

---

## 三、小结

通过在设计阶段明确词法分析的职责边界，并在实现过程中针对关键路径进行结构性优化，该词法分析模块在**正确性、可维护性与工程可读性**之间取得了良好平衡，为后续语法分析与语义处理阶段奠定了稳定基础。
