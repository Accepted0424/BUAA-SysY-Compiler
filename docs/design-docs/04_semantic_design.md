# 语义分析模块设计

## 一、编码前的设计规划

语义分析阶段位于语法分析之后，是连接前端结构分析与中间代码生成的关键环节。本模块的核心目标是在抽象语法树（AST）的基础上，结合符号表信息，对程序进行语义层面的正确性检查，并为后续 IR 构建提供必要的语义支撑。

### 1. 设计目标

语义分析模块主要承担以下职责：

* **符号定义与使用一致性检查**
  检测变量、常量与函数的重复定义、未定义使用等语义错误。
* **类型与参数匹配检查**
  验证表达式类型合法性、函数调用时实参与形参在数量与类型上的一致性。
* **控制流语义约束检查**
  确保 `break` / `continue` 语句仅出现在合法的循环语境中。
* **返回语句检查**
  校验函数返回语句与函数声明的返回类型是否匹配。
* **常量表达式求值**
  对可在编译期求值的表达式进行计算，为数组维度、`const` 定义等场景提供确定值。

### 2. 模块结构设计

在结构设计上，语义分析模块主要由以下几个核心组件构成：

* **符号表（SymbolTable）**
  采用支持**嵌套作用域**的数据结构，能够正确处理块作用域、函数作用域及全局作用域下的符号查找与屏蔽规则。
* **统一的 Visitor 处理机制**
  语义检查逻辑与中间代码生成逻辑统一集成在基于 Visitor 模式的 AST 遍历过程中，在一次遍历中完成：

  * 语义合法性验证；
  * 符号表维护；
  * 与 IR 构建相关的语义信息提取。
* **错误收集与输出机制**
  所有语义错误均通过统一的 `ErrorReporter` 模块进行记录、排序与集中输出，避免错误处理逻辑分散在各个节点中。

### 3. 关键语义检查点

在设计阶段明确的重点语义规则包括：

* 函数调用时实参与形参的**数量与类型严格匹配**；
* `const` 对象禁止在定义后被再次赋值；
* `break` 与 `continue` 语句仅允许出现在循环体内部；
* 变量与函数符号的作用域遮蔽规则正确生效。

---

## 二、编码完成后的实现调整与增强

在具体实现过程中，结合课程要求与实际调试需求，对原有设计进行了若干工程层面的补充与优化。

### 1. 符号表功能扩展

为满足课程实验的输出规范，`SymbolTable` 在原有嵌套作用域与符号查询功能的基础上，进一步引入了：

* **作用域编号（Scope ID）**
  用于区分不同作用域层级，便于调试与结果验证；
* **有序符号输出机制**
  保证符号信息在输出时顺序稳定、可预测。

这些扩展在不影响语义分析核心逻辑的前提下，增强了系统的可观测性。

### 2. 常量求值与 IR 构建的协同

在 Visitor 实现中，语义分析与 IR 构建被进一步深度融合：

* 在遍历 AST 的同时，对可在编译期确定的表达式执行常量折叠；
* 对 `const` 表达式与数组维度表达式，通过专用函数（如 `evalConstExpValue`）进行求值；
* 求值结果既用于语义检查，也直接服务于 IR 生成阶段。

该策略避免了额外的独立常量求值阶段，提高了整体实现的简洁性与执行效率。

### 3. 循环语义的精确控制

为确保 `break` 与 `continue` 语义检查的准确性，实现中引入了**循环栈（Loop Stack）**机制：

* 在进入循环结构时压栈；
* 在退出循环结构时出栈；
* 在处理 `break` / `continue` 节点时检查当前栈状态。

通过该方式，可以精确判断控制流语句所处的上下文，并生成准确的语义错误信息。

### 4. 统一的错误记录接口

所有语义错误均通过：

```cpp
ErrorReporter::error(...)
```

接口统一记录。
该设计保证了错误信息在来源、格式与排序上的一致性，同时也便于在后续阶段对错误处理策略进行扩展。

---

## 三、小结

本语义分析模块在整体架构上采用**符号表 + Visitor 遍历**的经典设计模式，并在实现过程中将语义检查与中间代码生成有机结合。在保证语义规则完整覆盖的同时，通过工程化的扩展（如循环栈、统一错误管理与常量求值机制），实现了功能完备、结构清晰且具有良好扩展性的语义分析阶段。
